#!/usr/bin/python3
import statistics
import csv
import sys
import subprocess as oss
import numpy as np
import matplotlib.pyplot as plt

def build():
	#oss.call(['rm', '-f', 'run', 'fun.o'])
	#oss.call(['nasm', '-f', 'elf64', 'fun.S', '-o', 'fun.o'])
	#oss.call(['gcc', 'main.c', '-o', 'run', 'fun.o', '-no-pie', '-O0'])
	oss.call(['cc', 'main.c', '-O0'])

def run():
	oss.call(['bash', 'run.bash'])

def modify_line(file_name, line_num, new_instruction):
	lines = open(file_name, 'r').readlines()
	lines[line_num] = new_instruction
	out = open(file_name, 'w')
	out.writelines(lines)
	out.close();

def read_line(file_name):
	lines = open(file_name, 'r').readlines()
	return lines[0]


def main(repeat_time = 250, start_time=0):
	results = [0] * repeat_time
	threshold = 220
	for i in range(start_time,repeat_time+1):
		#modify_line('./main.c', 67, 'asm volatile (\".rep ' + str(i) + '\");' + '\n')
		modify_line('./main.c', 29, 'asm volatile (\".rep ' + str(i) + '\");' + '\n')
		build()
		for j in range(1,101):
			run()
			results[i-1] = results[i-1] + int(read_line('tmp.txt'))
		print('', '%3d' % i, '', results[i-1] / 100)

	#with open('data/registerfile_SMT_partition2.txt', 'w') as f:
	with open('data/slow_value2.txt', 'w') as f:
		for result in results:
			f.write(str(result/100))
			f.write('\n')

	## Plot graph
	#x = np.arange(start_time, repeat_time+1)
	#plt.figure(figsize=(8, 8), dpi=80)
	#plt.xticks(np.linspace(start_time,repeat_time,10))
	#plt.plot(x,results)

	#result_tmp = np.array(results)
	#above_threshold = result_tmp > threshold
	#plt.scatter(x[above_threshold], result_tmp[above_threshold], color='red', s=10)

	#plt.title('Revese Engineer ROB Capacity SMT -- NOP')
	#plt.xlabel('Number of NOP')
	#plt.ylabel('Time Measurement')

	#plt.savefig('result.pdf')


if __name__ == "__main__":
    if(len(sys.argv) > 1):
        main(int(sys.argv[1]), int(sys.argv[2]))
    else:
        main()
